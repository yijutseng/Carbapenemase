---
title: "Carbapenemase Project - complete cases"
format: html
author: "Yi-Ju Tseng"
editor: visual
date-modified: 2024-08-01
---

```{r, message=FALSE, warning=FALSE}
#| echo: false
library(readxl)
library(tidyverse)
library(cvms)
library(patchwork)
highcolor<-"#526e97" # #08306B
```

```{r warning=FALSE, message=FALSE}
#| echo: false
#MixTable <- read_excel("CONFUSION MATRIX TABLE.xlsx", 
#    sheet = "Mix")
#MixTable$ID<-as.character(MixTable$ID)
source("Carbapenemase.R")
FinalCM<-FinalCM%>%filter(!is.na(MPCR))
lev<-c("OXA","KPC","KPC+OXA","VIM","IMP","NDM",
       "NDM+VIM","NDM+IMP",
       "OXA+VIM","OXA+IMP","OXA+NDM",
       "KPC+OXA+NDM","KPC+IMP","KPC+NDM","Negative"
       )
levGENE<-c("OXA","KPC+OXA","OXA+VIM","OXA+IMP","OXA+NDM","KPC+OXA+NDM",
           "KPC","KPC+IMP","KPC+NDM",
           "VIM","NDM+VIM","IMP","NDM","NDM+IMP","Negative"
       )
#FinalCM$GENE<-factor(FinalCM$GENE,levels=lev)
```

```{r warning=FALSE, message=FALSE}
#| echo: false

CIM_KP <- read_excel("20230307_CPO_BD_final.xlsx", 
    sheet = "KP")
CIM_Other <- read_excel("20230307_CPO_BD_final.xlsx", 
    sheet = "other")
col<-c("Accession","Organism","mCIM","eCIM","mCIM/eCIM Result")
CIMAll<-rbind(CIM_KP[,col],CIM_Other[,col])
CIMAll$ID<-gsub("CPO-","",CIMAll$Accession)
CIMAll<-CIMAll %>% filter(!is.na(mCIM)&!is.na(eCIM)&eCIM!=2&mCIM!="#REF!")
#table(CIMAll$eCIM)
#table(CIMAll$mCIM)
CIMAll$mCIM<-ifelse(CIMAll$mCIM==0,"(-)","(+)")
CIMAll$eCIM<-ifelse(CIMAll$eCIM==0,"(-)","(+)")
CIMAll$mCIMeCIM<-paste0("mCIM",CIMAll$mCIM,"/eCIM",CIMAll$eCIM)
CIMAll<-CIMAll %>% filter(!(mCIM=="(-)"&eCIM=="(+)"))
CIMAll$SPECIES<-ifelse(CIMAll$Organism=="Klebsiella pneumoniae","KP",
                    ifelse(CIMAll$Organism=="Klebsiella oxytoca","K.OXYTOCA",
                           ifelse(CIMAll$Organism=="Klebsiella aerogenes","K.AEROGENES",
                                  ifelse(CIMAll$Organism=="Escherichia coli","EC",
                                         ifelse(CIMAll$Organism=="Enterobacter cloacae complex","ENT.CLOACAE",
                                                ifelse(CIMAll$Organism=="Citrobacter koseri","CITRO.KOSERI",
                                                       ifelse(CIMAll$Organism=="Citrobacter freundii complex","CITRO.FREUNDII",
                                                              CIMAll$Organism)))))))


```

```{r warning=FALSE, message=FALSE}
#| echo: false
AST<-read_csv("20230307_CPO_BD_AST.csv")
AST<-AST %>% filter(grepl("CPO-",B)&Res!="X")%>%
  mutate(ID=gsub("CPO-","",B), 
         MarkerOld=Marker,
         Marker=ifelse(grepl("Class A|Class D",Marker),
                       "Class A or D",
                       ifelse(Marker=="Carbapenemase Producer","Class Unknown",
                              ifelse(grepl("Class B",Marker),"Class B",Marker))), 
         MarkerOld=ifelse(grepl("Class A",MarkerOld),
                       "Class A",
                       ifelse(grepl("Class D",MarkerOld),
                       "Class D",
                       ifelse(MarkerOld=="Carbapenemase Producer","Class Unknown",
                              ifelse(grepl("Class B",MarkerOld),"Class B",MarkerOld)))),
         Res=ifelse(Res=="S","S","R or I"))
AST$Marker<-ifelse(is.na(AST$Marker),"Negative",AST$Marker)
AST$SPECIES<-ifelse(AST$Name=="Klebsiella pneumoniae","KP",
                    ifelse(AST$Name=="Klebsiella oxytoca","K.OXYTOCA",
                           ifelse(AST$Name=="Klebsiella aerogenes","K.AEROGENES",
                                  ifelse(AST$Name=="Escherichia coli","EC",
                                         ifelse(AST$Name=="Enterobacter cloacae complex","ENT.CLOACAE",
                                                ifelse(AST$Name=="Citrobacter koseri","CITRO.KOSERI",
                                                       ifelse(AST$Name=="Citrobacter freundii complex","CITRO.FREUNDII",
                                                              AST$Name)))))))

AST<-AST %>% filter(!(ID=="32968" &Marker=="Negative"))%>% rename(CPO=Marker)

#AST_MPCR<-inner_join(AST,FinalCM,by=c("ID","SPECIES"))
#AST_MPCRGroup<-
#  AST_MPCR %>% group_by(MPCR,CARBA5,Ab,Res,GENE) %>%
#  summarise(Count=n())
ASTCPO<-AST%>%select(ID,Name,SPECIES,CPO,Ab,Res)  %>% unique()  
CPO<-
  AST%>%select(ID,Name,SPECIES,CPO) %>% unique() %>% 
  filter(!is.na(CPO)) 

```

```{r warning=F,message=F}
#| echo: false
## Data combine
## MPCR vs. CARBA5
### MPCR
MPCRPos<-
  FinalCM %>% select (-CARBA5) %>% filter(MPCR==1) %>%
  group_by(ID,SPECIES) %>% pivot_wider(names_from="GENE",values_from="MPCR") %>%
  mutate(KPC=ifelse(KPC==1,"KPC",NA),
         OXA=ifelse(OXA==1,"OXA",NA),
         NDM=ifelse(NDM==1,"NDM",NA),
         VIM=ifelse(VIM==1,"VIM",NA),
         IMP=ifelse(IMP==1,"IMP",NA)) %>%
  unite(.,col="MPCR",KPC,OXA,NDM,VIM,IMP, na.rm=TRUE, sep="+")
MPCRNeg<-
  FinalCM %>% select(ID,SPECIES) %>% unique() %>%
  anti_join(.,MPCRPos,by=c("ID","SPECIES"))
MPCRNeg$MPCR<-"Negative"
#MPCRNeg %>% filter(ID %in% MPCRPos$ID) # should be 0
MPCRFinal<-rbind(MPCRPos,MPCRNeg)
MPCRFinal$MPCR<-factor(MPCRFinal$MPCR,levels = rev(lev))

MPCRFinal$MPCRGroup<-
  ifelse(MPCRFinal$MPCR %in% c("KPC","OXA"), #,"KPC+OXA"
         "KPC/OXA",
         ifelse(MPCRFinal$MPCR %in% c("IMP","NDM","VIM"), #,"NDM+VIM"
         "IMP/NDM/VIM",
         ifelse(MPCRFinal$MPCR=="Negative","Negative","Others")))
MPCRFinal$MPCRGroup<-factor(MPCRFinal$MPCRGroup,
                        levels = rev(c("KPC/OXA","IMP/NDM/VIM","Others","Negative")))
### CARBA5
CARBA5Pos<-
  FinalCM %>% select (-MPCR) %>% filter(CARBA5==1) %>%
  group_by(ID,SPECIES) %>% pivot_wider(names_from="GENE",values_from="CARBA5") %>%
  mutate(KPC=ifelse(KPC==1,"KPC",NA),
         OXA=ifelse(OXA==1,"OXA",NA),
         NDM=ifelse(NDM==1,"NDM",NA),
         VIM=ifelse(VIM==1,"VIM",NA),
         IMP=ifelse(IMP==1,"IMP",NA)) %>%
  unite(.,col="CARBA5",KPC,OXA,NDM,VIM,IMP, na.rm=TRUE, sep="+")
CARBA5Neg<-
  FinalCM %>% select(ID,SPECIES) %>% unique() %>%
  anti_join(.,CARBA5Pos,by=c("ID","SPECIES")) # error here
CARBA5Neg$CARBA5<-"Negative"
#MPCRNeg %>% filter(ID %in% MPCRPos$ID) # should be 0
CARBA5Final<-rbind(CARBA5Pos,CARBA5Neg)
CARBA5Final$CARBA5<-factor(CARBA5Final$CARBA5,levels = rev(lev))

CARBA5Final$CARBA5Group<-
  ifelse(CARBA5Final$CARBA5 %in% c("KPC","OXA"), #,"KPC+OXA"
         "KPC/OXA",
         ifelse(CARBA5Final$CARBA5 %in% c("IMP","NDM","VIM"), #,"NDM+VIM"
         "IMP/NDM/VIM",
         ifelse(CARBA5Final$CARBA5=="Negative","Negative","Others")))
CARBA5Final$CARBA5Group<-factor(CARBA5Final$CARBA5Group,
                        levels = rev(c("KPC/OXA","IMP/NDM/VIM","Others","Negative")))



## CPO vs. CIM
CIMFinal<-CIMAll %>% select(ID,Organism,SPECIES,mCIMeCIM) %>% rename(Name=Organism)
CIMFinal$mCIMeCIM<-factor(CIMFinal$mCIMeCIM,
                              levels=c("mCIM(-)/eCIM(-)","mCIM(+)/eCIM(+)","mCIM(+)/eCIM(-)"))
CPOFinal<-CPO %>% select(ID,Name,SPECIES,CPO)
MPCRFinal<-MPCRFinal[complete.cases(MPCRFinal),]
CARBA5Final<-CARBA5Final[complete.cases(CARBA5Final),]
CIMFinal<-CIMFinal[complete.cases(CIMFinal),]
CPOFinal<-CPOFinal[complete.cases(CPOFinal),]
CombineData<-
  inner_join(MPCRFinal,CARBA5Final,by = join_by(ID, SPECIES)) %>%
  inner_join(.,CIMFinal,by = join_by(ID, SPECIES)) %>%
  inner_join(.,CPOFinal,by = join_by(ID, SPECIES))
CombineData$Name<-ifelse(!is.na(CombineData$Name.y),CombineData$Name.y,CombineData$Name.x)
CombineData<-CombineData %>%select(-Name.x,-Name.y)
#CombineData %>% group_by(ID,SPECIES) %>%
#  summarise(Count=n()) %>% arrange(desc(Count))
#write_csv(CombineData,"CombineData_comp.csv")
#CombineData<-CombineData[complete.cases(CombineData),]
```

**List of analyses**:

-   FirstAll vs. Conventional [link](#firstall-vs.-conventional)
-   CPO vs. mCIMeCIM [link](#cpo-vs.-mcimecim)
-   CPO vs. MPCR [link](#cpo-vs.-mpcr)
-   CPO vs. CARBA5 [link](#cpo-vs.-carba5)
-   CPO vs. AST [link](#cpo-vs.-ast)
-   MPCR vs. AST [link](#mpcr-vs.-ast)
-   All vs. MIC [link](#all-vs.-mic)
-   MPCR vs. CARBA5 [link](#mpcr-vs.-carba5)
-   PCR positive- CPO vs. CARBA5 [link](#pcr-positive--cpo-vs.-carba5)

**CIM grouping**:

-   mCIM-eCIM- =\> no carbapenemase detected
-   mCIM+eCIM- =\> class A or D
-   mCIM-eCIM+ =\> lab error? should be rechecked
-   mCIM+eCIM+ =\> classB

**MPCR & CARBA5 grouping**:

-   單一KPC或OXA：對應KPC/OXA
-   單一NDM或VIM或IMP：對應IMP/NDM/VIM
-   多樣偵測(e.g. KPC+OXA)：對應Others
-   沒有偵測到：對應Negative

# FirstAll vs. Conventional {#firstall-vs.-conventional}

```{r, message=FALSE, warning=FALSE}
#| echo: false
df.bd = read_excel("20221115_CPO_BD_KP.xlsx",sheet = "Raw")[,1:10]
df.w = read_excel("20221116_CPO_WANG_KP.xlsx",sheet = "KP")
```

```{r}
#| echo: false
########################################
#pre-processing
########################################
df.bd$ID = df.bd$ID %>% 
  str_sub(start = 5,end = 12)

df.bd = df.bd %>% 
  filter(BAC %in% c("Klebsiella pneumoniae"))

df.w$ID=df.w$ID %>% as.character()
```

```{r}
#| echo: false
########################################
#merge
########################################
df.merge = left_join(df.bd,df.w,by = "ID")
df.merge$mCIM.y = df.merge$mCIM.y %>% 
  str_replace(pattern = "\\+", 
              replacement = "1") %>% 
  str_replace( pattern = "\\-", 
              replacement = "0")
df.merge$eCIM.y = df.merge$eCIM.y %>% 
  str_replace(pattern = "\\+", 
              replacement = "1") %>% 
  str_replace( pattern = "\\-", 
              replacement = "0")
```

```{r}
#| echo: false
########################################
#stats
########################################
#df.merge<-df.merge %>% rename(Conventional=mCIM.x,FirstAll=mCIM.y)
#mat=cbind(df.merge$mCIM.x,df.merge$mCIM.y) %>% as.data.frame()
#colnames(mat) = c("Conventional","FirstAll")
df.merge=df.merge %>% 
  filter(mCIM.x %in% c(0,1)) %>% 
  filter(mCIM.y %in% c(0,1))
df.merge$mCIM.x<-ifelse(df.merge$mCIM.x==0,"(-)","(+)")
df.merge$mCIM.y<-ifelse(df.merge$mCIM.y==0,"(-)","(+)")
df.merge$eCIM.x<-ifelse(df.merge$eCIM.x==0,"(-)","(+)")
df.merge$eCIM.y<-ifelse(df.merge$eCIM.y==0,"(-)","(+)")
df.merge<-df.merge[df.merge$ID %in% CombineData$ID & !is.na(df.merge$mCIM.x)& !is.na(df.merge$mCIM.y)& df.merge$mCIM.x!="?"& df.merge$mCIM.y!="?",]
# CombineData %>% filter(SPECIES=="KP"& !(ID %in% # df.merge$ID)) %>% pull(ID) 33312
CombineData<-CombineData %>% filter(ID!="33312")
write_csv(CombineData,"CombineData_comp.csv")
write_csv(df.merge,"df.merge_comp.csv")
#CombineData<-semi_join(CombineData,KPData,by="ID")
mCIM.comp=table(df.merge$mCIM.x,df.merge$mCIM.y) 
dimnames(mCIM.comp)[[1]]<-c("Conventional-mCIM(-)","Conventional-mCIM(+)")
dimnames(mCIM.comp)[[2]]<-c("FirstAll-mCIM(-)","FirstAll-mCIM(+)")
mCIM.comp
# write.csv(mCIM.comp,"mCIM.comp_KP.csv",row.names = TRUE)
```

Figure 2

```{r warning=FALSE,fig.height=4,fig.width=4}
#| echo: false

eval <- evaluate(
  data = df.merge,
  target_col = "mCIM.x",
  prediction_cols = "mCIM.y",
  type="binomial",
  positive = "(+)"
)
plot_confusion_matrix(eval,
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="Conventional",y="FirstAll")
ggsave("Con_vs_FirstAll.pdf",device = "pdf",width = 4,height = 4)
```

# CPO vs. mCIMeCIM (Figure 3) {#cpo-vs.-mcimecim}

```{r warning=FALSE, message=FALSE}
#| echo: false
#CPO_CIM<-inner_join(CPOFinal,CIMFinal,by=c("ID","Name","SPECIES"))

CPO_CIMGroup<-
  CombineData %>%
  group_by(Name,CPO,mCIMeCIM) %>%
  summarise(Count=n())%>%
  ungroup() %>%
  complete(Name,CPO, mCIMeCIM, fill = list(Count = 0)) 

#CPO_CIMGroup<-
#  CPO_CIM %>%
#  group_by(Name,CPO,mCIMeCIM) %>%
#  summarise(Count=n())%>%
#  ungroup() %>%
#  complete(Name,CPO, mCIMeCIM, fill = list(Count = 0)) 

CPO_CIMGroup$Tag<-""
CPO_CIMGroup$Tag<-
  ifelse(CPO_CIMGroup$CPO!="Class A or D" &CPO_CIMGroup$CPO!="Class Unknown" & CPO_CIMGroup$mCIMeCIM=="mCIM(+)/eCIM(-)",
       "Conflict",CPO_CIMGroup$Tag)
CPO_CIMGroup$Tag<-
  ifelse(CPO_CIMGroup$CPO!="Class B" &CPO_CIMGroup$CPO!="Class Unknown" & CPO_CIMGroup$mCIMeCIM=="mCIM(+)/eCIM(+)",
       "Conflict",CPO_CIMGroup$Tag)
CPO_CIMGroup$Tag<-
  ifelse(CPO_CIMGroup$CPO!="Negative" & CPO_CIMGroup$mCIMeCIM=="mCIM(-)/eCIM(-)",
       "Conflict",CPO_CIMGroup$Tag)

CPO_CIMGroup$CPO<-gsub(" Producer","",CPO_CIMGroup$CPO)
knitr::kable(CPO_CIMGroup %>% filter(Count!=0))
```

(Figure 3)

```{r warning=FALSE, message=FALSE, fig.height=8,fig.width=12}
#| echo: false

KPCPO<-
  CPO_CIMGroup %>% filter(Name=="Klebsiella pneumoniae") %>%
  ggplot(aes(x=CPO,y=mCIMeCIM,fill=Count,label=Count)) +
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  theme_classic()+#mdthemes::md_theme_classic() +
  labs(x="CPO",y="mCIM/eCIM",title=expression(italic("Klebsiella pneumoniae")))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)
KOCPO<-
  CPO_CIMGroup %>% filter(Name=="Klebsiella oxytoca") %>%
  ggplot(aes(x=CPO,y=mCIMeCIM,fill=Count,label=Count)) +
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  theme_classic()+#mdthemes::md_theme_classic() +
  labs(x="CPO",y="mCIM/eCIM",title=expression(italic("Klebsiella oxytoca")))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)
KACOP<-
  CPO_CIMGroup %>% filter(Name=="Klebsiella aerogenes") %>%
  ggplot(aes(x=CPO,y=mCIMeCIM,fill=Count,label=Count)) +
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  theme_classic()+#mdthemes::md_theme_classic() +
  labs(x="CPO",y="mCIM/eCIM",title=expression(italic("Klebsiella aerogenes")))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor,breaks=c(0,3,6,9,12))
ECCPO<-
  CPO_CIMGroup %>% filter(Name=="Escherichia coli") %>%
  ggplot(aes(x=CPO,y=mCIMeCIM,fill=Count,label=Count)) +
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  theme_classic()+#mdthemes::md_theme_classic() +
  labs(x="CPO",y="mCIM/eCIM",title=expression(italic('Escherichia coli')))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)
ECCCPO<-
  CPO_CIMGroup %>% filter(Name=="Enterobacter cloacae complex") %>%
  ggplot(aes(x=CPO,y=mCIMeCIM,fill=Count,label=Count)) +
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  theme_classic()+#mdthemes::md_theme_classic() +
  labs(x="CPO",y="mCIM/eCIM",title=expression(italic("Enterobacter cloacae complex")))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)
CKCPO<-
  CPO_CIMGroup %>% filter(Name=="Citrobacter koseri") %>%
  ggplot(aes(x=CPO,y=mCIMeCIM,fill=Count,label=Count)) +
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  theme_classic()+#mdthemes::md_theme_classic() +
  labs(x="CPO",y="mCIM/eCIM",title=expression(italic("Citrobacter koseri")))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor,breaks=c(0,3,6,9,12))
CFCCPO<-
  CPO_CIMGroup %>% filter(Name=="Citrobacter freundii complex") %>%
  ggplot(aes(x=CPO,y=mCIMeCIM,fill=Count,label=Count)) +
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor,breaks=c(0,2,4,6,8))+
  labs(x="CPO",y="mCIM/eCIM",title=expression(italic('Citrobacter freundii complex')))+
  theme_classic()#+#mdthemes::md_theme_classic() +
  #theme(title = ggtext::element_markdown())

KPCPO+KOCPO+KACOP+ECCPO+ECCCPO+CKCPO+CFCCPO
```

# CPO vs. MPCR {#cpo-vs.-mpcr}

```{r warning=FALSE, message=FALSE}
#| echo: false


#CPO_MPCR<-inner_join(CPOFinal,MPCRFinal)
CombineData %>% filter(!is.na(CPO) &!is.na(MPCR)) #475
CPOMPCRGrpup<-
  CombineData %>% group_by(MPCR,MPCRGroup,CPO) %>%
  summarise(Count=n()) 
sum(CPOMPCRGrpup$Count) #475
knitr::kable(CPOMPCRGrpup)
CPOMPCRGrpup %>%
  ggplot(aes(x=CPO,y=MPCR,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="MPCR")
```

-   Gene grouping (Figure 4 A)

```{r warning=FALSE, message=FALSE}
#| echo: false

CPOMPCRGrpup %>% group_by(MPCRGroup,CPO) %>%
  summarise(Total=sum(Count)) %>% 
  ggplot(aes(x=CPO,y=MPCRGroup,fill=Total,label=Total))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="MPCR",fill="Count")
```

```{r warning=FALSE, message=FALSE,fig.height=8,fig.width=12}
#| echo: false
CombineData %>% group_by(Name,MPCRGroup,CPO) %>%
  summarise(Total=n()) %>% 
  ggplot(aes(x=CPO,y=MPCRGroup,fill=Total,label=Total))+
  facet_wrap(fct_rev(Name)~.)+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="MPCR",fill="Count")+
  theme( strip.text = element_text(face = "italic"))
```
## Klebsiella pneumoniae

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Klebsiella pneumoniae")%>%
  group_by(MPCR,CPO) %>%
  summarise(Count=n()) %>%
  ggplot(aes(x=CPO,y=MPCR,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="MPCR",title=expression(italic('Klebsiella pneumoniae')))
```

-   Gene grouping

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Klebsiella pneumoniae")%>% 
  group_by(MPCRGroup,CPO) %>%
  summarise(Total=n()) %>% 
  ggplot(aes(x=CPO,y=MPCRGroup,fill=Total,label=Total))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="MPCR",fill="Count",title=expression(italic('Klebsiella pneumoniae')))
```

## Escherichia coli

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Escherichia coli")%>%
  group_by(MPCR,CPO) %>%
  summarise(Count=n()) %>%
  ggplot(aes(x=CPO,y=MPCR,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="MPCR",title=expression(italic('Escherichia coli')))

```

-   Gene grouping

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Escherichia coli")%>% 
  group_by(MPCRGroup,CPO) %>%
  summarise(Total=n()) %>% 
  ggplot(aes(x=CPO,y=MPCRGroup,fill=Total,label=Total))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="MPCR",fill="Count",title=expression(italic('Escherichia coli')))
```

## Enterobacter cloacae complex

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Enterobacter cloacae complex")%>%
  group_by(MPCR,CPO) %>%
  summarise(Count=n()) %>%
  ggplot(aes(x=CPO,y=MPCR,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="MPCR",title=expression(italic('Enterobacter cloacae complex')))

```

-   Gene grouping

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Enterobacter cloacae complex")%>% 
  group_by(MPCRGroup,CPO) %>%
  summarise(Total=n()) %>% 
  ggplot(aes(x=CPO,y=MPCRGroup,fill=Total,label=Total))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="MPCR",fill="Count",title=expression(italic('Enterobacter cloacae complex')))
```

## CITRO.FREUNDII

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Citrobacter freundii complex")%>%
  group_by(MPCR,CPO) %>%
  summarise(Count=n()) %>%
  ggplot(aes(x=CPO,y=MPCR,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="MPCR",title=expression(italic('Citrobacter freundii complex')))

```

-   Gene grouping

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Citrobacter freundii complex")%>% 
  group_by(MPCRGroup,CPO) %>%
  summarise(Total=n()) %>% 
  ggplot(aes(x=CPO,y=MPCRGroup,fill=Total,label=Total))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="MPCR",fill="Count",title=expression(italic('Citrobacter freundii complex')))
```

## CITRO.KOSERI

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Citrobacter koseri")%>%
  group_by(MPCR,CPO) %>%
  summarise(Count=n()) %>%
  ggplot(aes(x=CPO,y=MPCR,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="MPCR",title=expression(italic('Citrobacter koseri')))

```

-   Gene grouping

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Citrobacter koseri")%>% 
  group_by(MPCRGroup,CPO) %>%
  summarise(Total=n()) %>% 
  ggplot(aes(x=CPO,y=MPCRGroup,fill=Total,label=Total))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="MPCR",fill="Count",title=expression(italic('Citrobacter koseri')))
```

## K.AEROGENES

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Klebsiella aerogenes")%>%
  group_by(MPCR,CPO) %>%
  summarise(Count=n()) %>%
  ggplot(aes(x=CPO,y=MPCR,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="MPCR",title=expression(italic('Klebsiella aerogenes')))

```

-   Gene grouping

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Klebsiella aerogenes")%>% 
  group_by(MPCRGroup,CPO) %>%
  summarise(Total=n()) %>% 
  ggplot(aes(x=CPO,y=MPCRGroup,fill=Total,label=Total))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="MPCR",fill="Count",title=expression(italic('Klebsiella aerogenes')))
```

## K.oxytoca

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Klebsiella oxytoca")%>%
  group_by(MPCR,CPO) %>%
  summarise(Count=n()) %>%
  ggplot(aes(x=CPO,y=MPCR,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="MPCR",title=expression(italic('Klebsiella oxytoca')))

```

-   Gene grouping

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Klebsiella oxytoca")%>% 
  group_by(MPCRGroup,CPO) %>%
  summarise(Total=n()) %>% 
  ggplot(aes(x=CPO,y=MPCRGroup,fill=Total,label=Total))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="MPCR",fill="Count",title=expression(italic('Klebsiella oxytoca')))
```

# CPO vs. CARBA5 {#cpo-vs.-carba5} (Figure 5 A)

```{r warning=FALSE, message=FALSE}
#| echo: false
#CPO_CARBA5<-inner_join(CPOFinal,CARBA5Final)


CombineData %>% group_by(CARBA5,CARBA5Group,CPO) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=CPO,y=CARBA5,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="CARBA5")

```

-   Gene grouping (Figure 5 A)

```{r warning=F,message=F}
#| echo: false
CombineData %>% group_by(CARBA5Group,CPO) %>%
  summarise(Total=n()) %>% 
  ggplot(aes(x=CPO,y=CARBA5Group,fill=Total,label=Total))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="CARBA5",fill="Count")
```

## Klebsiella pneumoniae

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Klebsiella pneumoniae")%>%
  group_by(CARBA5,CPO) %>%
  summarise(Count=n()) %>%
  ggplot(aes(x=CPO,y=CARBA5,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="CARBA5",title=expression(italic('Klebsiella pneumoniae')))


```

-   Gene grouping

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Klebsiella pneumoniae")%>% 
  group_by(CARBA5Group,CPO) %>%
  summarise(Total=n()) %>% 
  ggplot(aes(x=CPO,y=CARBA5Group,fill=Total,label=Total))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="CARBA5",fill="Count",title=expression(italic('Klebsiella pneumoniae')))
```

## Escherichia coli

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Escherichia coli")%>%
  group_by(CARBA5,CPO) %>%
  summarise(Count=n()) %>%
  ggplot(aes(x=CPO,y=CARBA5,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="CARBA5",title=expression(italic('Escherichia coli')))

```

-   Gene grouping

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Escherichia coli")%>% 
  group_by(CARBA5Group,CPO) %>%
  summarise(Total=n()) %>% 
  ggplot(aes(x=CPO,y=CARBA5Group,fill=Total,label=Total))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="CARBA5",fill="Count",title=expression(italic('Escherichia coli')))
```

## Enterobacter cloacae complex

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Enterobacter cloacae complex")%>%
  group_by(CARBA5,CPO) %>%
  summarise(Count=n()) %>%
  ggplot(aes(x=CPO,y=CARBA5,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="CARBA5",title=expression(italic('Enterobacter cloacae complex')))

```

-   Gene grouping

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Enterobacter cloacae complex")%>% 
  group_by(CARBA5Group,CPO) %>%
  summarise(Total=n()) %>% 
  ggplot(aes(x=CPO,y=CARBA5Group,fill=Total,label=Total))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="CARBA5",fill="Count",title=expression(italic('Enterobacter cloacae complex')))
```

## CITRO.FREUNDII

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Citrobacter freundii complex")%>%
  group_by(CARBA5,CPO) %>%
  summarise(Count=n()) %>%
  ggplot(aes(x=CPO,y=CARBA5,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="CARBA5",title=expression(italic('Citrobacter freundii complex')))

```

-   Gene grouping

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Citrobacter freundii complex")%>% 
  group_by(CARBA5Group,CPO) %>%
  summarise(Total=n()) %>% 
  ggplot(aes(x=CPO,y=CARBA5Group,fill=Total,label=Total))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="CARBA5",fill="Count",title=expression(italic('Citrobacter freundii complex')))
```

## CITRO.KOSERI

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Citrobacter koseri")%>%
  group_by(CARBA5,CPO) %>%
  summarise(Count=n()) %>%
  ggplot(aes(x=CPO,y=CARBA5,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="CARBA5",title=expression(italic('Citrobacter koseri')))

```

-   Gene grouping

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Citrobacter koseri")%>% 
  group_by(CARBA5Group,CPO) %>%
  summarise(Total=n()) %>% 
  ggplot(aes(x=CPO,y=CARBA5Group,fill=Total,label=Total))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="CARBA5",fill="Count",title=expression(italic('Citrobacter koseri')))
```

## K.AEROGENES

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Klebsiella aerogenes")%>%
  group_by(CARBA5,CPO) %>%
  summarise(Count=n()) %>%
  ggplot(aes(x=CPO,y=CARBA5,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="CARBA5",title=expression(italic('Klebsiella aerogenes')))

```

-   Gene grouping

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Klebsiella aerogenes")%>% 
  group_by(CARBA5Group,CPO) %>%
  summarise(Total=n()) %>% 
  ggplot(aes(x=CPO,y=CARBA5Group,fill=Total,label=Total))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="CARBA5",fill="Count",title=expression(italic('Klebsiella aerogenes')))
```

## K.oxytoca

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Klebsiella oxytoca")%>%
  group_by(CARBA5,CPO) %>%
  summarise(Count=n()) %>%
  ggplot(aes(x=CPO,y=CARBA5,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="CARBA5",title=expression(italic('Klebsiella oxytoca')))

```

-   Gene grouping

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(Name=="Klebsiella oxytoca")%>% 
  group_by(CARBA5Group,CPO) %>%
  summarise(Total=n()) %>% 
  ggplot(aes(x=CPO,y=CARBA5Group,fill=Total,label=Total))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+labs(x="CPO",y="CARBA5",fill="Count",title=expression(italic('Klebsiella oxytoca')))
```

# CPO vs. AST {#cpo-vs.-ast}

-   Not class B, but Ceftazidime-Avibactam R

## Not class B, but Ceftazidime-Avibactam R

```{r warning=FALSE, message=FALSE}
#| echo: false
ASTCPOGroup<-
  ASTCPO %>% filter(Ab %in% c("Ceftazidime-Avibactam")) %>%
  group_by(Name,CPO,Ab,Res) %>%
  summarise(Count=n())
knitr::kable(ASTCPOGroup)
```

```{r warning=FALSE, message=FALSE}
#| echo: false
ASTCPOGroup %>% filter(Ab=="Ceftazidime-Avibactam") %>%
  ggplot(aes(x=Res,y=Count,label=Count,fill=Name))+
  geom_bar(stat="identity")+
  #geom_text()+
  scale_fill_brewer(palette = "Dark2")+
  facet_grid(.~CPO)+
  theme_bw()
```

# MPCR vs. AST {#mpcr-vs.-ast}

20230502

```{r warning=FALSE, message=FALSE}
#| echo: false
CAAST<-AST %>% filter(Ab=="Ceftazidime-Avibactam") %>%
             select(ID,Name,SPECIES,Ab,Res)
MPCRPos<-
  FinalCM %>% select (-CARBA5) %>% filter(MPCR==1) 
MPCRNeg<-
  FinalCM%>% select(-CARBA5,ID,SPECIES) %>% unique() %>%
  anti_join(.,MPCRPos,by=c("ID","SPECIES"))
MPCRNeg$GENE<-"Negative"
#MPCRNeg %>% filter(ID %in% MPCRPos$ID)
MPCRAll<-rbind(MPCRPos,MPCRNeg)
MPCRAll<-
  MPCRAll%>% select(ID,SPECIES,GENE) %>%
  group_by(ID,SPECIES) %>%
  summarise(GENEGroup=paste0(GENE, collapse = "+")) %>%
  mutate(GENEGroup=ifelse(grepl("Negative",GENEGroup),"Negative",GENEGroup))
MPCRAll$GENEGroup<-factor(MPCRAll$GENEGroup,levels = rev(lev))

MPCRAll$GENENew<-
  ifelse(MPCRAll$GENEGroup %in% c("KPC","OXA"), #,"KPC+OXA"
         "KPC/OXA",
         ifelse(MPCRAll$GENEGroup %in% c("IMP","NDM","VIM"), #,"NDM+VIM"
         "IMP/NDM/VIM",
         ifelse(MPCRAll$GENEGroup=="Negative","Negative","Others")))
MPCRAll$GENENew<-factor(MPCRAll$GENENew,
                        levels = c("KPC/OXA","IMP/NDM/VIM","Others","Negative"))

MPCR_CAAST<-inner_join(MPCRAll,CAAST,by=c("ID","SPECIES")) %>% filter(ID %in% CombineData$ID)

MPCR_CAAST %>% group_by(Name,GENENew,Res) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Res,y=Count,label=Count,fill=Name))+
  geom_bar(stat="identity")+
  #geom_text()+
  scale_fill_brewer(palette = "Dark2")+
  facet_grid(.~GENENew)+
  theme_bw()
```

# All vs. MIC {#all-vs.-mic}

-   Ertapenem, Imipenem, Meropenem **每個抗生素分開呈現**:
    -   MIC vs mCIM/eCIM
    -   MIC vs MPCR
    -   MIC vs CARBA5
    -   MIC vs CPO
-   Add Ceftazidime-Avibactam 20230502

## MIC vs. CPO

```{r warning=FALSE, message=FALSE}
#| echo: false
MICCPO<-AST %>% select(ID,Name,SPECIES,Tit,Ab,CPO) %>% unique() %>%
  filter(Ab %in% c("Ertapenem","Imipenem","Meropenem","Ceftazidime-Avibactam") &
           ID %in% CombineData$ID)
# MICCPO$Tit<-ifelse(grepl("1\xa4\xeb4\xa4\xe9",MICCPO$Tit),"1/4",
#                    ifelse(grepl("2\xa4\xeb4\xa4\xe9",MICCPO),"2/4",
#                           ifelse(grepl("4\xa4\xeb4\xa4\xe9",MICCPO$Tit),"4/4",
#                                  ifelse(grepl("8\xa4\xeb4\xa4\xe9",MICCPO$Tit),"8/4",MICCPO$Tit))))
MICCPO$CPO<-factor(MICCPO$CPO,
                      levels = c("Negative","Class B","Class Unknown","Class A or D"))
MICCPO$Tit<-factor(MICCPO$Tit,
                   levels = c("<=0.25","<=0.25/4", "0.5","0.5/4","1","1/4",">1","2","2/4","4","4/4","8","8/4",">8",">8/4","16","32",">32"))

MICCPO %>% filter(Ab=="Meropenem") %>%
  group_by(Tit,CPO) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=CPO,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+
  labs(x="MIC",y="CPO",title="Meropenem")
MICCPO %>% filter(Ab=="Imipenem") %>%
  group_by(Tit,CPO) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=CPO,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+
  labs(x="MIC",y="CPO",title="Imipenem")
MICCPO %>% filter(Ab=="Ertapenem") %>%
  group_by(Tit,CPO) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=CPO,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+
  labs(x="MIC",y="CPO",title="Ertapenem")
MICCPO %>% filter(Ab=="Ceftazidime-Avibactam") %>%
  group_by(Tit,CPO) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=CPO,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+
  labs(x="MIC",y="CPO",title="Ceftazidime-Avibactam")
```

(Figure 6 A)

## MIC vs. mCIM/eCIM

```{r warning=FALSE, message=FALSE}
#| echo: false
MICCPOCIM<-
  inner_join(MICCPO,CombineData, by = c("ID", "Name", "SPECIES", "CPO")) 
MICCPOCIM$mCIMeCIM<-factor(MICCPOCIM$mCIMeCIM,
                           levels=c("mCIM(-)/eCIM(-)","mCIM(+)/eCIM(+)","mCIM(+)/eCIM(-)" ))
MICCPOCIM %>% filter(Ab=="Meropenem") %>%
  group_by(Tit,mCIMeCIM) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=mCIMeCIM,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+
  labs(x="MIC",y="mCIM/eCIM",title="Meropenem")
MICCPOCIM %>% filter(Ab=="Imipenem") %>%
  group_by(Tit,mCIMeCIM) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=mCIMeCIM,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+
  labs(x="MIC",y="mCIM/eCIM",title="Imipenem")
MICCPOCIM %>% filter(Ab=="Ertapenem") %>%
  group_by(Tit,mCIMeCIM) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=mCIMeCIM,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+
  labs(x="MIC",y="mCIM/eCIM",title="Ertapenem")
MICCPOCIM %>% filter(Ab=="Ceftazidime-Avibactam") %>%
  group_by(Tit,mCIMeCIM) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=mCIMeCIM,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+
  labs(x="MIC",y="mCIM/eCIM",title="Ceftazidime-Avibactam")
```

## MIC vs. MPCR

20230430

```{r warning=FALSE, message=FALSE}
#| echo: false
MICCPOMPCR<-
  inner_join(MICCPO,CombineData, by = c("ID", "SPECIES"))

MICCPOMPCR %>% filter(Ab=="Meropenem") %>%
  group_by(Tit,MPCR) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=MPCR,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+
  labs(x="MIC",y="MPCR",title="Meropenem")

MICCPOMPCR %>% filter(Ab=="Imipenem") %>%
  group_by(Tit,MPCR) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=MPCR,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+
  labs(x="MIC",y="MPCR",title="Imipenem")

MICCPOMPCR %>% filter(Ab=="Ertapenem") %>%
  group_by(Tit,MPCR) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=MPCR,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+
  labs(x="MIC",y="MPCR",title="Ertapenem")

MICCPOMPCR %>% filter(Ab=="Ceftazidime-Avibactam") %>%
  group_by(Tit,MPCR) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=MPCR,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+
  labs(x="MIC",y="MPCR",title="Ceftazidime-Avibactam")
```

### Gene grouping

```{r warning=F,message=F}
#| echo: false
MICCPOMPCR %>% filter(Ab=="Meropenem") %>%
  group_by(Tit,MPCRGroup) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=MPCRGroup,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+
  labs(x="MIC",y="MPCR",title="Meropenem")
MICCPOMPCR %>% filter(Ab=="Imipenem") %>%
  group_by(Tit,MPCRGroup) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=MPCRGroup,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+
  labs(x="MIC",y="MPCR",title="Imipenem")
MICCPOMPCR %>% filter(Ab=="Ertapenem") %>%
  group_by(Tit,MPCRGroup) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=MPCRGroup,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+
  labs(x="MIC",y="MPCR",title="Ertapenem")
MICCPOMPCR %>% filter(Ab=="Ceftazidime-Avibactam") %>%
  group_by(Tit,MPCRGroup) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=MPCRGroup,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+
  labs(x="MIC",y="MPCR",title="Ceftazidime-Avibactam")
```

## MIC vs. CARBA5

```{r warning=FALSE, message=FALSE}
#| echo: false
MICCPOCARBA5<-
  inner_join(MICCPO,CombineData, by = c("ID", "SPECIES"))

MICCPOCARBA5 %>% filter(Ab=="Meropenem") %>%
  group_by(Tit,CARBA5) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=CARBA5,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+
  labs(x="MIC",y="CARBA5",title="Meropenem")

MICCPOCARBA5 %>% filter(Ab=="Imipenem") %>%
  group_by(Tit,CARBA5) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=CARBA5,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+
  labs(x="MIC",y="CARBA5",title="Imipenem")

MICCPOCARBA5 %>% filter(Ab=="Ertapenem") %>%
  group_by(Tit,CARBA5) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=CARBA5,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+
  labs(x="MIC",y="CARBA5",title="Ertapenem")

MICCPOCARBA5 %>% filter(Ab=="Ceftazidime-Avibactam") %>%
  group_by(Tit,CARBA5) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=CARBA5,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+
  labs(x="MIC",y="CARBA5",title="Ceftazidime-Avibactam")

```

### Gene grouping (Figure 6 B)

```{r warning=F,message=F}
#| echo: false
MICCPOCARBA5 %>% filter(Ab=="Meropenem") %>%
  group_by(Tit,CARBA5Group) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=CARBA5Group,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+
  labs(x="MIC",y="CARBA5",title="Meropenem")
MICCPOCARBA5 %>% filter(Ab=="Imipenem") %>%
  group_by(Tit,CARBA5Group) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=CARBA5Group,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+
  labs(x="MIC",y="CARBA5",title="Imipenem")
MICCPOCARBA5 %>% filter(Ab=="Ertapenem") %>%
  group_by(Tit,CARBA5Group) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=CARBA5Group,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+
  labs(x="MIC",y="CARBA5",title="Ertapenem")
MICCPOCARBA5 %>% filter(Ab=="Ceftazidime-Avibactam") %>%
  group_by(Tit,CARBA5Group) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=CARBA5Group,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)+
  theme_classic()+
  labs(x="MIC",y="CARBA5",title="Ceftazidime-Avibactam")
```

(Figure 6 B)

# MPCR vs. CARBA5 {#mpcr-vs.-carba5}

```{r warning=FALSE, message=FALSE}
#| echo: false
#CARBA5_MPCR<-inner_join(CARBA5Final,MPCRFinal, by = c("ID","SPECIES"))
CombineData %>% filter(!is.na(CARBA5) &!is.na(MPCR)) #475
CombineData$CARBA5Group<-fct_rev(CombineData$CARBA5Group)
CARBA5_MPCRGroup<-
  CombineData %>%
  group_by(SPECIES,CARBA5Group,MPCRGroup) %>%
  summarise(Count=n())%>%
  ungroup() %>%
  complete(SPECIES,CARBA5Group,MPCRGroup, fill = list(Count = 0)) 
NameSP<-CPOFinal %>% select(SPECIES,Name) %>% unique()
CARBA5_MPCRGroup<-inner_join(CARBA5_MPCRGroup,NameSP,by="SPECIES")

```

## All (Figure 4 B)
```{r warning=F,message=F}
#| echo: false
CombineData %>%
  group_by(CARBA5Group,MPCRGroup) %>%
  summarise(Count=n())%>%
  ungroup() %>%
      ggplot(aes(x=CARBA5Group,y=MPCRGroup,fill=Count,label=Count))+
      geom_tile()+geom_text()+
      scale_x_discrete(guide = guide_axis(n.dodge=2))+
      theme_classic()+
      labs(x="CARBA5",y="MPCR")+
      scale_fill_gradient(low="#F7FBFF",high=highcolor)
```

```{r warning=F,message=F, fig.height=8,fig.width=12}
#| echo: false
CARBA5_MPCRGroup %>%
      ggplot(aes(x=CARBA5Group,y=MPCRGroup,fill=Count,label=Count))+
      facet_wrap(fct_rev(Name)~.)+
      geom_tile()+geom_text()+
      scale_x_discrete(guide = guide_axis(n.dodge=2))+
      theme_classic()+
  theme( strip.text = element_text(face = "italic"))+
      labs(x="CARBA5",y="MPCR")+
      scale_fill_gradient(low="#F7FBFF",high=highcolor)
```

```{r warning=F,message=F, fig.height=8,fig.width=12}
#| echo: false
CARBA5_MPCRKP<-CARBA5_MPCRGroup %>% filter(SPECIES=="KP") %>% 
      ggplot(aes(x=CARBA5Group,y=MPCRGroup,fill=Count,label=Count))+
      geom_tile()+geom_text()+
      scale_x_discrete(guide = guide_axis(n.dodge=2))+
      theme_classic()+
      labs(x="CARBA5",y="MPCR",title=expression(italic('Klebsiella pneumoniae')))+
      scale_fill_gradient(low="#F7FBFF",high=highcolor)
CARBA5_MPCRKO<-CARBA5_MPCRGroup %>% filter(SPECIES=="K.OXYTOCA") %>% 
      ggplot(aes(x=CARBA5Group,y=MPCRGroup,fill=Count,label=Count))+
      geom_tile()+geom_text()+
      scale_x_discrete(guide = guide_axis(n.dodge=2))+
      theme_classic()+
      labs(x="CARBA5",y="MPCR",title=expression(italic('Klebsiella oxytoca')))+
      scale_fill_gradient(low="#F7FBFF",high=highcolor,breaks=c(0,3,6,9,12))
CARBA5_MPCRCK<-CARBA5_MPCRGroup %>% filter(SPECIES=="CITRO.KOSERI") %>% 
      ggplot(aes(x=CARBA5Group,y=MPCRGroup,fill=Count,label=Count))+
      geom_tile()+geom_text()+
      scale_x_discrete(guide = guide_axis(n.dodge=2))+
      theme_classic()+
      labs(x="CARBA5",y="MPCR",title=expression(italic('Citrobacter koseri')))+
      scale_fill_gradient(low="#F7FBFF",high=highcolor,breaks=c(0,3,6,9,12))
CARBA5_MPCRCFC<-CARBA5_MPCRGroup %>% filter(SPECIES=="CITRO.FREUNDII") %>% 
      ggplot(aes(x=CARBA5Group,y=MPCRGroup,fill=Count,label=Count))+
      geom_tile()+geom_text()+
      scale_x_discrete(guide = guide_axis(n.dodge=2))+
      theme_classic()+
      labs(x="CARBA5",y="MPCR",title=expression(italic('Citrobacter freundii complex')))+
      scale_fill_gradient(low="#F7FBFF",high=highcolor)
CARBA5_MPCRKA<-CARBA5_MPCRGroup %>% filter(SPECIES=="K.AEROGENES") %>% 
      ggplot(aes(x=CARBA5Group,y=MPCRGroup,fill=Count,label=Count))+
      geom_tile()+geom_text()+
      scale_x_discrete(guide = guide_axis(n.dodge=2))+
      theme_classic()+
      labs(x="CARBA5",y="MPCR",title=expression(italic('Klebsiella aerogenes')))+
      scale_fill_gradient(low="#F7FBFF",high=highcolor)
CARBA5_MPCREC<-CARBA5_MPCRGroup %>% filter(SPECIES=="EC") %>% 
      ggplot(aes(x=CARBA5Group,y=MPCRGroup,fill=Count,label=Count))+
      geom_tile()+geom_text()+
      scale_x_discrete(guide = guide_axis(n.dodge=2))+
      theme_classic()+
      labs(x="CARBA5",y="MPCR",title=expression(italic('Escherichia coli')))+
      scale_fill_gradient(low="#F7FBFF",high=highcolor)
CARBA5_MPCRECC<-CARBA5_MPCRGroup %>% filter(SPECIES=="EC") %>% 
      ggplot(aes(x=CARBA5Group,y=MPCRGroup,fill=Count,label=Count))+
      geom_tile()+geom_text()+
      scale_x_discrete(guide = guide_axis(n.dodge=2))+
      theme_classic()+
      labs(x="CARBA5",y="MPCR",title=expression(italic('Enterobacter cloacae complex')))+
      scale_fill_gradient(low="#F7FBFF",high=highcolor)
CARBA5_MPCRKP+CARBA5_MPCRKO+CARBA5_MPCRKA+CARBA5_MPCREC+CARBA5_MPCRECC+CARBA5_MPCRCK+CARBA5_MPCRCFC
```

## Klebsiella pneumoniae

-   Grouping (**first try**, x-y modified)

```{r warning=F,message=F}
#| echo: false
    CombineData %>% filter(SPECIES=="KP") %>% 
      group_by(CARBA5Group,MPCRGroup) %>%
      summarise(Count=n())%>%
      ggplot(aes(x=CARBA5Group,y=MPCRGroup,fill=Count,label=Count))+
      geom_tile()+geom_text()+
      scale_x_discrete(guide = guide_axis(n.dodge=2))+
      theme_classic()+
      labs(x="CARBA5",y="MPCR",title=expression(italic('Klebsiella pneumoniae')))+
      scale_fill_gradient(low="#F7FBFF",high=highcolor)
```

-   Multiple genes (**first try**)

```{r warning=F,message=F}
#| echo: false
CombineData %>% filter(SPECIES=="KP") %>% 
  group_by(CARBA5,MPCR) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=CARBA5,y=MPCR,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  theme_classic()+
  labs(x="CARBA5",y="MPCR",title=expression(italic('Klebsiella pneumoniae')))+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)
```

-   Single Gene

```{r warning=F,message=F}
#| echo: false
KP<-FinalCM %>% filter(SPECIES=="KP" & ID %in% CombineData$ID) #1500
KPGroup<-
  KP %>%
  group_by(GENE,MPCR,CARBA5, .drop = FALSE) %>%
  summarise(N=n()) %>% 
  rename(Prediction=CARBA5,Target=MPCR)%>%
  ungroup() %>%
  complete(Prediction, Target, GENE, fill = list(N = 0)) 

(plot_confusion_matrix(KPGroup %>% filter(GENE=="OXA"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="OXA"))+
(plot_confusion_matrix(KPGroup %>% filter(GENE=="KPC"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="KPC"))+
(plot_confusion_matrix(KPGroup %>% filter(GENE=="VIM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="VIM"))+
  (plot_confusion_matrix(KPGroup %>% filter(GENE=="IMP"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="IMP"))+
  (plot_confusion_matrix(KPGroup %>% filter(GENE=="NDM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="NDM"))
```

## Escherichia coli

```{r warning=F,message=F}
#| echo: false
EC<-FinalCM %>% filter(SPECIES=="EC"& ID %in% CombineData$ID) #1500
eval <- evaluate(
  data = EC %>% filter(GENE!="IMP")%>%group_by(GENE),
  target_col = "MPCR",
  prediction_cols = "CARBA5",
  type="binomial",parallel = T
)
ECGroup<-
  EC %>%
  group_by(GENE,MPCR,CARBA5, .drop = FALSE) %>%
  summarise(N=n()) %>% 
  rename(Prediction=CARBA5,Target=MPCR)%>%
  ungroup() %>%
  complete(Prediction, Target, GENE, fill = list(N = 0)) 

(plot_confusion_matrix(ECGroup %>% filter(GENE=="OXA"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="OXA"))+
  (plot_confusion_matrix(ECGroup %>% filter(GENE=="KPC"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="KPC"))+
(plot_confusion_matrix(ECGroup %>% filter(GENE=="VIM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="VIM"))+
  (plot_confusion_matrix(ECGroup %>% filter(GENE=="IMP"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="IMP"))+
  (plot_confusion_matrix(ECGroup %>% filter(GENE=="NDM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="NDM"))
```

## Enterobacter cloacae complex

```{r warning=F,message=F}
#| echo: false
ECC<-FinalCM %>% filter(SPECIES=="ENT.CLOACAE"& ID %in% CombineData$ID) #1500
eval <- evaluate(
  data = ECC %>% filter(GENE!="VIM")%>%group_by(GENE),
  target_col = "MPCR",
  prediction_cols = "CARBA5",
  type="binomial",parallel = T
)
ECCGroup<-
  ECC %>%
  group_by(GENE,MPCR,CARBA5, .drop = FALSE) %>%
  summarise(N=n()) %>% 
  rename(Prediction=CARBA5,Target=MPCR)%>%
  ungroup() %>%
  complete(Prediction, Target, GENE, fill = list(N = 0)) 
(plot_confusion_matrix(ECCGroup %>% filter(GENE=="OXA"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="OXA"))+
  (plot_confusion_matrix(ECCGroup %>% filter(GENE=="KPC"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="KPC"))+
(plot_confusion_matrix(ECCGroup %>% filter(GENE=="VIM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="VIM"))+
  (plot_confusion_matrix(ECCGroup %>% filter(GENE=="IMP"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="IMP"))+
  (plot_confusion_matrix(ECCGroup %>% filter(GENE=="NDM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="NDM"))
```

## CITRO.FREUNDII

```{r warning=F,message=F}
#| echo: false
CF<-FinalCM %>% filter(SPECIES=="CITRO.FREUNDII"& ID %in% CombineData$ID) #1500
eval <- evaluate(
  data = CF %>%group_by(GENE),
  target_col = "MPCR",
  prediction_cols = "CARBA5",
  type="binomial",parallel = T
)
CFGroup<-
  CF %>%
  group_by(GENE,MPCR,CARBA5, .drop = FALSE) %>%
  summarise(N=n()) %>% 
  rename(Prediction=CARBA5,Target=MPCR)%>%
  ungroup() %>%
  complete(Prediction, Target, GENE, fill = list(N = 0)) 
(plot_confusion_matrix(CFGroup %>% filter(GENE=="OXA"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="OXA"))+

(plot_confusion_matrix(CFGroup %>% filter(GENE=="KPC"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="KPC"))+
(plot_confusion_matrix(CFGroup %>% filter(GENE=="VIM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="VIM"))+
  (plot_confusion_matrix(CFGroup %>% filter(GENE=="IMP"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="IMP"))+
  (plot_confusion_matrix(CFGroup %>% filter(GENE=="NDM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="NDM"))
```

## CITRO.KOSERI

```{r warning=F,message=F}
#| echo: false
CK<-FinalCM %>% filter(SPECIES=="CITRO.KOSERI"& ID %in% CombineData$ID) #1500
eval <- evaluate(
  data = CK %>% filter(!GENE %in% c("NDM","VIM","OXA")) %>%group_by(GENE),
  target_col = "MPCR",
  prediction_cols = "CARBA5",
  type="binomial",parallel = T
)
CKGroup<-
  CK %>%
  group_by(GENE,MPCR,CARBA5, .drop = FALSE) %>%
  summarise(N=n()) %>% 
  rename(Prediction=CARBA5,Target=MPCR)%>%
  ungroup() %>%
  complete(Prediction, Target, GENE, fill = list(N = 0)) 
(plot_confusion_matrix(CKGroup %>% filter(GENE=="OXA"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="OXA"))+
(plot_confusion_matrix(CKGroup %>% filter(GENE=="KPC"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="KPC"))+
  (plot_confusion_matrix(CKGroup %>% filter(GENE=="VIM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="VIM"))+
  (plot_confusion_matrix(CKGroup %>% filter(GENE=="IMP"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="IMP"))+
(plot_confusion_matrix(CKGroup %>% filter(GENE=="NDM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="NDM"))


```

## K.AEROGENES

```{r warning=F,message=F}
#| echo: false
KA<-FinalCM %>% filter(SPECIES=="K.AEROGENES"& ID %in% CombineData$ID) #1500
eval <- evaluate(
  data = KA %>% filter(GENE %in% c("IMP","OXA"))%>%group_by(GENE),
  target_col = "MPCR",
  prediction_cols = "CARBA5",
  type="binomial",parallel = T
)
KAGroup<-
  KA %>%
  group_by(GENE,MPCR,CARBA5, .drop = FALSE) %>%
  summarise(N=n()) %>% 
  rename(Prediction=CARBA5,Target=MPCR)%>%
  ungroup() %>%
  complete(Prediction, Target, GENE, fill = list(N = 0)) 
(plot_confusion_matrix(KAGroup %>% filter(GENE=="OXA"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="OXA"))+
(plot_confusion_matrix(KAGroup %>% filter(GENE=="KPC"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="KPC"))+
(plot_confusion_matrix(KAGroup %>% filter(GENE=="VIM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="VIM"))+
  (plot_confusion_matrix(KAGroup %>% filter(GENE=="IMP"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="IMP"))+
  (plot_confusion_matrix(KAGroup %>% filter(GENE=="NDM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="NDM"))
```

## K.OXYTOCA

```{r warning=F,message=F}
#| echo: false
KO<-FinalCM %>% filter(SPECIES=="K.OXYTOCA"& ID %in% CombineData$ID) #1500
eval <- evaluate(
  data = KO %>% filter(GENE!="IMP")%>%group_by(GENE),
  target_col = "MPCR",
  prediction_cols = "CARBA5",
  type="binomial",parallel = T
)
KOGroup<-
  KO %>%
  group_by(GENE,MPCR,CARBA5, .drop = FALSE) %>%
  summarise(N=n()) %>% 
  rename(Prediction=CARBA5,Target=MPCR)%>%
  ungroup() %>%
  complete(Prediction, Target, GENE, fill = list(N = 0)) 
(plot_confusion_matrix(KOGroup %>% filter(GENE=="OXA"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="OXA"))+
(plot_confusion_matrix(KOGroup %>% filter(GENE=="KPC"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="KPC"))+
  (plot_confusion_matrix(KOGroup %>% filter(GENE=="VIM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="VIM"))+
 (plot_confusion_matrix(KOGroup %>% filter(GENE=="IMP"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="IMP"))+
(plot_confusion_matrix(KOGroup %>% filter(GENE=="NDM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="NDM"))


```

# PCR positive- CPO vs. CARBA5 (Figure 5 B) {#pcr-positive--cpo-vs.-carba5}

all SPECIES 20230502 CPO NA -\> no results in file.

```{r warning=F,message=F}
#| echo: false
#CombineData %>%
#  filter(MPCR=="Negative")
#CombineData %>%
#  filter(is.na(MPCR))
CombineData %>%
  filter(MPCR!="Negative" & !is.na(MPCR)) %>%
  filter(!is.na(CARBA5Group)&!is.na(CPO)) %>%
  group_by(CPO,CARBA5Group) %>%
  summarise(Count=n()) %>%
  ggplot(aes(x=CPO,y=CARBA5Group,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  theme_classic()+
  labs(x="CPO",y="CARBA5")+
  scale_fill_gradient(low="#F7FBFF",high=highcolor)
```

```{r warning=F,message=F}
#| echo: false
#| eval: false
# For test
CombineData %>%
  filter(grepl("OXA",CARBA5) & CPO=="Class A or D") %>%
  group_by(SPECIES) %>%
  summarise(Count=n())
CombineData %>%
  filter(mCIMeCIM=="mCIM(+)/eCIM(+)" & CPO=="Class A or D") %>%
  group_by(SPECIES) %>%
  summarise(Count=n())
CombineData %>%
  filter(grepl("OXA",CARBA5) & grepl("OXA",MPCR)) %>%
  group_by(SPECIES) %>%
  summarise(Count=n())
```
