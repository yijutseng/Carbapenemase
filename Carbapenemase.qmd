---
title: "Carbapenemase Project"
format: html
author: "Yi-Ju Tseng"
editor: visual
---

# FirstAll vs. Conventional

```{r, message=FALSE, warning=FALSE}
#| echo: false
library(readxl)
library(tidyverse)
library(cvms)
library(patchwork)
```

```{r, message=FALSE, warning=FALSE}
#| echo: false
df.bd = read_excel("20221115_CPO_BD_KP.xlsx",sheet = "Raw")[,1:10]
df.w = read_excel("20221116_CPO_WANG_KP.xlsx",sheet = "KP")
```

```{r}
#| echo: false
########################################
#pre-processing
########################################
df.bd$ID = df.bd$ID %>% 
  str_sub(start = 5,end = 12)

df.bd = df.bd %>% 
  filter(BAC %in% c("Klebsiella pneumoniae"))

df.w$ID=df.w$ID %>% as.character()
```

```{r}
#| echo: false
########################################
#merge
########################################
df.merge = left_join(df.bd,df.w,by = "ID")
df.merge$mCIM.y = df.merge$mCIM.y %>% 
  str_replace(pattern = "\\+", 
              replacement = "1") %>% 
  str_replace( pattern = "\\-", 
              replacement = "0")
df.merge$eCIM.y = df.merge$eCIM.y %>% 
  str_replace(pattern = "\\+", 
              replacement = "1") %>% 
  str_replace( pattern = "\\-", 
              replacement = "0")
```

```{r}
#| echo: false
########################################
#stats
########################################
#df.merge<-df.merge %>% rename(Conventional=mCIM.x,FirstAll=mCIM.y)
#mat=cbind(df.merge$mCIM.x,df.merge$mCIM.y) %>% as.data.frame()
#colnames(mat) = c("Conventional","FirstAll")
df.merge=df.merge %>% 
  filter(mCIM.x %in% c(0,1)) %>% 
  filter(mCIM.y %in% c(0,1))
df.merge$mCIM.x<-ifelse(df.merge$mCIM.x==0,"(-)","(+)")
df.merge$mCIM.y<-ifelse(df.merge$mCIM.y==0,"(-)","(+)")
df.merge$eCIM.x<-ifelse(df.merge$eCIM.x==0,"(-)","(+)")
df.merge$eCIM.y<-ifelse(df.merge$eCIM.y==0,"(-)","(+)")
mCIM.comp=table(df.merge$mCIM.x,df.merge$mCIM.y) 
dimnames(mCIM.comp)[[1]]<-c("Conventional-mCIM(-)","Conventional-mCIM(+)")
dimnames(mCIM.comp)[[2]]<-c("FirstAll-mCIM(-)","FirstAll-mCIM(+)")
mCIM.comp
# write.csv(mCIM.comp,"mCIM.comp_KP.csv",row.names = TRUE)
```

```{r warning=FALSE,fig.height=4,fig.width=4}
#| echo: false

eval <- evaluate(
  data = df.merge,
  target_col = "mCIM.x",
  prediction_cols = "mCIM.y",
  type="binomial",
  positive = "(+)"
)
plot_confusion_matrix(eval,
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="Conventional",y="FirstAll")
ggsave("Con_vs_FirstAll.pdf",device = "pdf",width = 4,height = 4)
```

# MPCR vs. CARBA5

- Add GENE combination (TBD)

```{r warning=FALSE, message=FALSE}
#| echo: false
#MixTable <- read_excel("CONFUSION MATRIX TABLE.xlsx", 
#    sheet = "Mix")
#MixTable$ID<-as.character(MixTable$ID)
source("Carbapenemase.R")
FinalCM<-FinalCM%>%filter(!is.na(MPCR))

FinalCM %>%
  group_by(SPECIES,GENE) %>%
  summarise(NumberOfPatients=n()) %>%knitr::kable()
```

## Klebsiella pneumoniae

```{r warning=F,message=F}
#| echo: false
KP<-FinalCM %>% filter(SPECIES=="KP") #1500
#eval <- evaluate(
#  data = KP %>% filter(!is.na(MPCR))%>%group_by(GENE),
#  target_col = "MPCR",
#  prediction_cols = "CARBA5",
#  type="binomial",parallel = T
#)
KPGroup<-
  KP %>%
  group_by(GENE,MPCR,CARBA5, .drop = FALSE) %>%
  summarise(N=n()) %>% 
  rename(Prediction=CARBA5,Target=MPCR)%>%
  ungroup() %>%
  complete(Prediction, Target, GENE, fill = list(N = 0)) 


(plot_confusion_matrix(KPGroup %>% filter(GENE=="IMP"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="IMP"))+
(plot_confusion_matrix(KPGroup %>% filter(GENE=="KPC"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="KPC"))+
(plot_confusion_matrix(KPGroup %>% filter(GENE=="NDM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="NDM"))+
(plot_confusion_matrix(KPGroup %>% filter(GENE=="OXA"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="OXA"))+
(plot_confusion_matrix(KPGroup %>% filter(GENE=="VIM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="VIM"))
```

## Escherichia coli

```{r warning=F,message=F}
#| echo: false
EC<-FinalCM %>% filter(SPECIES=="EC") #1500
eval <- evaluate(
  data = EC %>% filter(GENE!="IMP")%>%group_by(GENE),
  target_col = "MPCR",
  prediction_cols = "CARBA5",
  type="binomial",parallel = T
)
ECGroup<-
  EC %>%
  group_by(GENE,MPCR,CARBA5, .drop = FALSE) %>%
  summarise(N=n()) %>% 
  rename(Prediction=CARBA5,Target=MPCR)%>%
  ungroup() %>%
  complete(Prediction, Target, GENE, fill = list(N = 0)) 
(plot_confusion_matrix(ECGroup %>% filter(GENE=="IMP"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="IMP"))+
(plot_confusion_matrix(ECGroup %>% filter(GENE=="KPC"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="KPC"))+
(plot_confusion_matrix(ECGroup %>% filter(GENE=="NDM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="NDM"))+
(plot_confusion_matrix(ECGroup %>% filter(GENE=="OXA"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="OXA"))+
(plot_confusion_matrix(ECGroup %>% filter(GENE=="VIM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="VIM"))
```

## Enterobacter cloacae complex

```{r warning=F,message=F}
#| echo: false
ECC<-FinalCM %>% filter(SPECIES=="ENT.CLOACAE") #1500
eval <- evaluate(
  data = ECC %>% filter(GENE!="VIM")%>%group_by(GENE),
  target_col = "MPCR",
  prediction_cols = "CARBA5",
  type="binomial",parallel = T
)
ECCGroup<-
  ECC %>%
  group_by(GENE,MPCR,CARBA5, .drop = FALSE) %>%
  summarise(N=n()) %>% 
  rename(Prediction=CARBA5,Target=MPCR)%>%
  ungroup() %>%
  complete(Prediction, Target, GENE, fill = list(N = 0)) 
(plot_confusion_matrix(ECCGroup %>% filter(GENE=="IMP"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="IMP"))+
(plot_confusion_matrix(ECCGroup %>% filter(GENE=="KPC"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="KPC"))+
(plot_confusion_matrix(ECCGroup %>% filter(GENE=="NDM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="NDM"))+
(plot_confusion_matrix(ECCGroup %>% filter(GENE=="OXA"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="OXA"))+
(plot_confusion_matrix(ECCGroup %>% filter(GENE=="VIM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="VIM"))
```

## CITRO.FREUNDII

```{r warning=F,message=F}
#| echo: false
CF<-FinalCM %>% filter(SPECIES=="CITRO.FREUNDII") #1500
eval <- evaluate(
  data = CF %>%group_by(GENE),
  target_col = "MPCR",
  prediction_cols = "CARBA5",
  type="binomial",parallel = T
)
CFGroup<-
  CF %>%
  group_by(GENE,MPCR,CARBA5, .drop = FALSE) %>%
  summarise(N=n()) %>% 
  rename(Prediction=CARBA5,Target=MPCR)%>%
  ungroup() %>%
  complete(Prediction, Target, GENE, fill = list(N = 0)) 
(plot_confusion_matrix(CFGroup %>% filter(GENE=="IMP"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="IMP"))+
(plot_confusion_matrix(CFGroup %>% filter(GENE=="KPC"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="KPC"))+
(plot_confusion_matrix(CFGroup %>% filter(GENE=="NDM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="NDM"))+
(plot_confusion_matrix(CFGroup %>% filter(GENE=="OXA"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="OXA"))+
(plot_confusion_matrix(CFGroup %>% filter(GENE=="VIM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="VIM"))
```

## CITRO.KOSERI

```{r warning=F,message=F}
#| echo: false
CK<-FinalCM %>% filter(SPECIES=="CITRO.KOSERI") #1500
eval <- evaluate(
  data = CK %>% filter(!GENE %in% c("NDM","VIM","OXA")) %>%group_by(GENE),
  target_col = "MPCR",
  prediction_cols = "CARBA5",
  type="binomial",parallel = T
)
CKGroup<-
  CK %>%
  group_by(GENE,MPCR,CARBA5, .drop = FALSE) %>%
  summarise(N=n()) %>% 
  rename(Prediction=CARBA5,Target=MPCR)%>%
  ungroup() %>%
  complete(Prediction, Target, GENE, fill = list(N = 0)) 
(plot_confusion_matrix(CKGroup %>% filter(GENE=="IMP"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="IMP"))+
(plot_confusion_matrix(CKGroup %>% filter(GENE=="KPC"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="KPC"))+
(plot_confusion_matrix(CKGroup %>% filter(GENE=="NDM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="NDM"))+
(plot_confusion_matrix(CKGroup %>% filter(GENE=="OXA"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="OXA"))+
(plot_confusion_matrix(CKGroup %>% filter(GENE=="VIM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="VIM"))
```

## K.AEROGENES

```{r warning=F,message=F}
#| echo: false
KA<-FinalCM %>% filter(SPECIES=="K.AEROGENES") #1500
eval <- evaluate(
  data = KA %>% filter(GENE %in% c("IMP","OXA"))%>%group_by(GENE),
  target_col = "MPCR",
  prediction_cols = "CARBA5",
  type="binomial",parallel = T
)
KAGroup<-
  KA %>%
  group_by(GENE,MPCR,CARBA5, .drop = FALSE) %>%
  summarise(N=n()) %>% 
  rename(Prediction=CARBA5,Target=MPCR)%>%
  ungroup() %>%
  complete(Prediction, Target, GENE, fill = list(N = 0)) 
(plot_confusion_matrix(KAGroup %>% filter(GENE=="IMP"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="IMP"))+
(plot_confusion_matrix(KAGroup %>% filter(GENE=="KPC"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="KPC"))+
(plot_confusion_matrix(KAGroup %>% filter(GENE=="NDM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="NDM"))+
(plot_confusion_matrix(KAGroup %>% filter(GENE=="OXA"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="OXA"))+
(plot_confusion_matrix(KAGroup %>% filter(GENE=="VIM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="VIM"))
```

## K.AEROGENES

```{r warning=F,message=F}
#| echo: false
KO<-FinalCM %>% filter(SPECIES=="K.OXYTOCA") #1500
eval <- evaluate(
  data = KO %>% filter(GENE!="IMP")%>%group_by(GENE),
  target_col = "MPCR",
  prediction_cols = "CARBA5",
  type="binomial",parallel = T
)
KOGroup<-
  KO %>%
  group_by(GENE,MPCR,CARBA5, .drop = FALSE) %>%
  summarise(N=n()) %>% 
  rename(Prediction=CARBA5,Target=MPCR)%>%
  ungroup() %>%
  complete(Prediction, Target, GENE, fill = list(N = 0)) 
(plot_confusion_matrix(KOGroup %>% filter(GENE=="IMP"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="IMP"))+
(plot_confusion_matrix(KOGroup %>% filter(GENE=="KPC"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="KPC"))+
(plot_confusion_matrix(KOGroup %>% filter(GENE=="NDM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="NDM"))+
(plot_confusion_matrix(KOGroup %>% filter(GENE=="OXA"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="OXA"))+
(plot_confusion_matrix(KOGroup %>% filter(GENE=="VIM"),
  counts_on_top=TRUE,add_normalized=FALSE)+
  labs(x="MPCR",y="CARBA5",title="VIM"))
```

```{r warning=FALSE, message=FALSE}
#| echo: false
#FinalCM %>% filter(SPECIES=="KP") %>%
#  ggplot(aes(x=MPCR))+
#  geom_bar()+
#  facet_grid(paste0("CARBA 5:",CARBA5)~GENE,scales ="free")+
#  scale_x_continuous(breaks = c(0,1))+
#  theme_bw()
```

```{r warning=FALSE, message=FALSE}
#| echo: false
AST<-read_csv("20230307_CPO_BD_AST.csv")
AST<-AST %>% filter(grepl("CPO-",B)&Res!="X")%>%
  mutate(ID=gsub("CPO-","",B), 
         Marker=ifelse(grepl("Class A|Class D",Marker),
                       "Class A or D",
                       ifelse(Marker=="Carbapenemase Producer","Class Unknown",
                              ifelse(grepl("Class B",Marker),"Class B",Marker))), 
         Res=ifelse(Res=="S","S","R or I"))
AST$Marker<-ifelse(is.na(AST$Marker),"Negative",AST$Marker)
AST$SPECIES<-ifelse(AST$Name=="Klebsiella pneumoniae","KP",
                    ifelse(AST$Name=="Klebsiella oxytoca","K.OXYTOCA",
                           ifelse(AST$Name=="Klebsiella aerogenes","K.AEROGENES",
                                  ifelse(AST$Name=="Escherichia coli","EC",
                                         ifelse(AST$Name=="Enterobacter cloacae complex","ENT.CLOACAE",
                                                ifelse(AST$Name=="Citrobacter koseri","CITRO.KOSERI",
                                                       ifelse(AST$Name=="Citrobacter freundii complex","CITRO.FREUNDII",
                                                              AST$Name)))))))

AST<-AST %>% filter(!(ID=="32968" &Marker=="Negative"))

AST_MPCR<-inner_join(AST,FinalCM,by=c("ID","SPECIES"))
AST_MPCRGroup<-
  AST_MPCR %>% group_by(MPCR,CARBA5,Ab,Res) %>%
  summarise(Count=n())
ASTCPO<-AST%>%select(ID,Name,SPECIES,Marker,Ab,Res) %>% unique() 
CPO<-
  AST%>%select(ID,Name,SPECIES,Marker) %>% unique() %>% 
  filter(!is.na(Marker)) 

```


# CPO, mCIM, and eCIM (FirstAll)
```{r warning=FALSE, message=FALSE}
#| echo: false

CIM_KP <- read_excel("20230307_CPO_BD_final.xlsx", 
    sheet = "KP")
CIM_Other <- read_excel("20230307_CPO_BD_final.xlsx", 
    sheet = "other")
col<-c("Accession","Organism","mCIM","eCIM","mCIM/eCIM Result")
CIMAll<-rbind(CIM_KP[,col],CIM_Other[,col])
CIMAll$ID<-gsub("CPO-","",CIMAll$Accession)
CIMAll<-CIMAll %>% filter(!is.na(mCIM)&!is.na(eCIM)&eCIM!=2&mCIM!="#REF!")
#table(CIMAll$eCIM)
#table(CIMAll$mCIM)
CIMAll$mCIM<-ifelse(CIMAll$mCIM==0,"(-)","(+)")
CIMAll$eCIM<-ifelse(CIMAll$eCIM==0,"(-)","(+)")
CPO_CIM<-inner_join(CPO,CIMAll,by=c("ID","Name"="Organism"))
```

- mCIM-eCIM- => no carbapenemase detected **(unknown? or NA?)**
- mCIM+eCIM- => class A or D **(How about unknown?)**
- mCIM-eCIM+ => lab error? should be rechecked
- mCIM+eCIM+ => classB **(How about unknown?)**

```{r warning=FALSE, message=FALSE}
#| echo: false
CPO_CIM$mCIMeCIM<-paste0("mCIM",CPO_CIM$mCIM,"/eCIM",CPO_CIM$eCIM)
CPO_CIM<-CPO_CIM %>% filter(!(mCIM=="(-)"&eCIM=="(+)"))
CPO_CIMGroup<-
  CPO_CIM %>%
  group_by(Name,Marker,mCIMeCIM) %>%
  summarise(Count=n())%>%
  ungroup() %>%
  complete(Name,Marker, mCIMeCIM, fill = list(Count = 0)) 

CPO_CIMGroup$Tag<-""
CPO_CIMGroup$Tag<-
  ifelse(CPO_CIMGroup$Marker!="Class A or D" &CPO_CIMGroup$Marker!="Class Unknown" & CPO_CIMGroup$mCIMeCIM=="mCIM(+)/eCIM(-)",
       "Conflict",CPO_CIMGroup$Tag)
CPO_CIMGroup$Tag<-
  ifelse(CPO_CIMGroup$Marker!="Class B" &CPO_CIMGroup$Marker!="Class Unknown" & CPO_CIMGroup$mCIMeCIM=="mCIM(+)/eCIM(+)",
       "Conflict",CPO_CIMGroup$Tag)
CPO_CIMGroup$Tag<-
  ifelse(CPO_CIMGroup$Marker!="Negative" & CPO_CIMGroup$mCIMeCIM=="mCIM(-)/eCIM(-)",
       "Conflict",CPO_CIMGroup$Tag)

CPO_CIMGroup$Marker<-gsub(" Producer","",CPO_CIMGroup$Marker)
knitr::kable(CPO_CIMGroup %>% filter(Count!=0))
```


```{r warning=FALSE, message=FALSE, fig.height=10,fig.width=15}
#| echo: false
#CPO_CIMGroup$Target<-CPO_CIMGroup$mCIM
#CPO_CIMGroup$Prediction<-CPO_CIMGroup$eCIM
#CPO_CIMGroup$N<-CPO_CIMGroup$Count
# (plot_confusion_matrix(CPO_CIMGroup %>% 
#                          filter(Name=="Klebsiella pneumoniae"&
#                                   Marker=="Carbapenemase"),
#   counts_on_top=TRUE,add_normalized=FALSE)+
#   labs(x="mCIM",y="eCIM",title="Carbapenemase"))+
# (plot_confusion_matrix(CPO_CIMGroup %>% filter(Name=="Klebsiella pneumoniae"&Marker=="Class B Carbapenemase"),
#   counts_on_top=TRUE,add_normalized=FALSE)+
#   labs(x="mCIM",y="eCIM",title="Class B Carbapenemase"))+
# (plot_confusion_matrix(CPO_CIMGroup %>% filter(Name=="Klebsiella pneumoniae"&Marker=="Class A or D Carbapenemase"),
#   counts_on_top=TRUE,add_normalized=FALSE)+
#   labs(x="mCIM",y="eCIM",title="Class A or D Carbapenemase"))
#table(CPO_CIMGroup$Name)
KPCPO<-
  CPO_CIMGroup %>% filter(Name=="Klebsiella pneumoniae") %>%
  ggplot(aes(x=Marker,y=mCIMeCIM,fill=Count,label=Count)) +
  geom_tile()+geom_text()+
  theme_bw()+mdthemes::md_theme_classic() +
  labs(x="CPO",y="mCIM/eCIM",title="*Klebsiella pneumoniae*")+
  scale_fill_gradient(low="#F7FBFF",high="#08306B")
KOCPO<-
  CPO_CIMGroup %>% filter(Name=="Klebsiella oxytoca") %>%
  ggplot(aes(x=Marker,y=mCIMeCIM,fill=Count,label=Count)) +
  geom_tile()+geom_text()+
  theme_bw()+mdthemes::md_theme_classic() +
  labs(x="CPO",y="mCIM/eCIM",title="*Klebsiella oxytoca*")+
  scale_fill_gradient(low="#F7FBFF",high="#08306B")
KACOP<-
  CPO_CIMGroup %>% filter(Name=="Klebsiella aerogenes") %>%
  ggplot(aes(x=Marker,y=mCIMeCIM,fill=Count,label=Count)) +
  geom_tile()+geom_text()+
  theme_bw()+mdthemes::md_theme_classic() +
  labs(x="CPO",y="mCIM/eCIM",title="*Klebsiella aerogenes*")+
  scale_fill_gradient(low="#F7FBFF",high="#08306B")
ECCPO<-
  CPO_CIMGroup %>% filter(Name=="Escherichia coli") %>%
  ggplot(aes(x=Marker,y=mCIMeCIM,fill=Count,label=Count)) +
  geom_tile()+geom_text()+
  theme_classic()+#mdthemes::md_theme_classic() +
  labs(x="CPO",y="mCIM/eCIM",title=expression(italic('Escherichia coli')))+
  scale_fill_gradient(low="#F7FBFF",high="#08306B")
ECCCPO<-
  CPO_CIMGroup %>% filter(Name=="Enterobacter cloacae complex") %>%
  ggplot(aes(x=Marker,y=mCIMeCIM,fill=Count,label=Count)) +
  geom_tile()+geom_text()+
  mdthemes::md_theme_classic() +
  labs(x="CPO",y="mCIM/eCIM",title="*Enterobacter cloacae complex*")+
  scale_fill_gradient(low="#F7FBFF",high="#08306B")
CKCPO<-
  CPO_CIMGroup %>% filter(Name=="Citrobacter koseri") %>%
  ggplot(aes(x=Marker,y=mCIMeCIM,fill=Count,label=Count)) +
  geom_tile()+geom_text()+
  mdthemes::md_theme_classic() +
  labs(x="CPO",y="mCIM/eCIM",title="*Citrobacter koseri*")+
  scale_fill_gradient(low="#F7FBFF",high="#08306B")
CFCCPO<-
  CPO_CIMGroup %>% filter(Name=="Citrobacter freundii complex") %>%
  ggplot(aes(x=Marker,y=mCIMeCIM,fill=Count,label=Count)) +
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high="#08306B")+
  labs(x="CPO",y="mCIM/eCIM",title=expression(italic('Citrobacter freundii complex')))+
  theme_classic()#+#mdthemes::md_theme_classic() +
  #theme(title = ggtext::element_markdown())

KPCPO+KOCPO+KACOP+ECCPO+ECCCPO+CKCPO+CFCCPO
```


# CPO vs. MPCR and CARBA5

!??TBD

```{r warning=FALSE, message=FALSE}
#| echo: false
inner_join(CPO,FinalCM %>% select(-GENE) %>% unique(), 
           by = c("ID", "SPECIES"))
```

## Klebsiella pneumoniae
!??TBD
```{r warning=F,message=F}
#| echo: false

```

## Escherichia coli
!??TBD
```{r warning=F,message=F}
#| echo: false

```

## Enterobacter cloacae complex
!??TBD
```{r warning=F,message=F}
#| echo: false

```

## CITRO.FREUNDII
!??TBD
```{r warning=F,message=F}
#| echo: false

```

## CITRO.KOSERI
!??TBD
```{r warning=F,message=F}
#| echo: false

```

## K.AEROGENES
!??TBD
```{r warning=F,message=F}
#| echo: false

```

## K.AEROGENES
!??TBD
```{r warning=F,message=F}
#| echo: false

```

# CPO vs. AST

- Not class B, but Ceftazidime-Avibactam R
- Ertapenem, Imipenem, Meropenem **每個抗生素分開呈現**: 
    - MIC vs mCIM/eCIM
    - MIC vs MPCR
    - MIC vs CARBA5
    - MIC vs CPO
    

## Not class B, but Ceftazidime-Avibactam R

```{r warning=FALSE, message=FALSE}
#| echo: false

ASTCPOGroup<-
  ASTCPO %>% filter(Ab %in% c("Ceftazidime-Avibactam")) %>%
  group_by(Name,Marker,Ab,Res) %>%
  summarise(Count=n())
knitr::kable(ASTCPOGroup)
```

```{r warning=FALSE, message=FALSE}
#| echo: false
ASTCPOGroup %>% filter(Ab=="Ceftazidime-Avibactam") %>%
  ggplot(aes(x=Res,y=Count,label=Count,fill=Name))+
  geom_bar(stat="identity")+
  #geom_text()+
  scale_fill_brewer(palette = "Dark2")+
  facet_grid(.~Marker)+
  theme_bw()
```

## Ertapenem, Imipenem, Meropenem

### MIC vs. CPO
```{r warning=FALSE, message=FALSE}
#| echo: false
MICCPO<-AST %>% select(ID,Name,SPECIES,Tit,Ab,Marker) %>% unique() %>%
  filter(Ab %in% c("Ertapenem","Imipenem","Meropenem"))
MICCPO$Marker<-factor(MICCPO$Marker,
                      levels = c("Negative","Class B","Class Unknown","Class A or D"))
MICCPO$Tit<-factor(MICCPO$Tit,
                   levels = c("<=0.25", "0.5","1",">1","2","4","8",">8","16","32"))
MICCPO %>% filter(Ab=="Meropenem") %>%
  group_by(Tit,Marker) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=Marker,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high="#08306B")+
  theme_classic()+
  labs(x="MIC",y="CPO",title="Meropenem")
MICCPO %>% filter(Ab=="Imipenem") %>%
  group_by(Tit,Marker) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=Marker,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high="#08306B")+
  theme_classic()+
  labs(x="MIC",y="CPO",title="Imipenem")
MICCPO %>% filter(Ab=="Ertapenem") %>%
  group_by(Tit,Marker) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=Marker,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high="#08306B")+
  theme_classic()+
  labs(x="MIC",y="CPO",title="Ertapenem")
```
### MIC vs. mCIM/eCIM
```{r warning=FALSE, message=FALSE}
#| echo: false
MICCPOCIM<-
  inner_join(MICCPO,CPO_CIM, by = c("ID", "Name", "SPECIES", "Marker"))
MICCPOCIM$mCIMeCIM<-factor(MICCPOCIM$mCIMeCIM,
                           levels=c("mCIM(-)/eCIM(-)","mCIM(+)/eCIM(+)","mCIM(+)/eCIM(-)" ))
MICCPOCIM %>% filter(Ab=="Meropenem") %>%
  group_by(Tit,mCIMeCIM) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=mCIMeCIM,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high="#08306B")+
  theme_classic()+
  labs(x="MIC",y="CPO",title="Meropenem")
MICCPOCIM %>% filter(Ab=="Imipenem") %>%
  group_by(Tit,mCIMeCIM) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=mCIMeCIM,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high="#08306B")+
  theme_classic()+
  labs(x="MIC",y="CPO",title="Imipenem")
MICCPOCIM %>% filter(Ab=="Ertapenem") %>%
  group_by(Tit,mCIMeCIM) %>%
  summarise(Count=n())%>%
  ggplot(aes(x=Tit,y=mCIMeCIM,fill=Count,label=Count))+
  geom_tile()+geom_text()+
  scale_fill_gradient(low="#F7FBFF",high="#08306B")+
  theme_classic()+
  labs(x="MIC",y="CPO",title="Ertapenem")
```

### MIC vs. MPCR
TBD

### MIC vs. CARBA5
TBD
